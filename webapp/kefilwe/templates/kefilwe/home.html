{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>
    <style>
      #container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: #f2f2f2;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #header {
        font-family: ITCAvantGardeStd-Bk,Arial,sans-serif;
        font-size: 50px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1 id="header">Welcome {{ name }}</h1><br>
      <!-- <img id ="map" src="{% static 'maze.jpeg' %}" alt="maze" width="500" height="500" style="border: 1px solid #000000;"/> -->
    </div>

    <py-config type="toml">
      packages = [
        "opencv-python",
        "scikit-image"
      ]
    </py-config>
    
    <py-script src="{% static 'bfs.py' %}"></py-script>

    <!-- <script src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <script type="text/javascript" onload>
      const map = document.getElementById("map");

      class Point {
        constructor(x, y) {
          this.x = x;
          this.y = y;
        }

        add(other) {
          return new Point(this.x + other.x, this.y + other.y);
        }

        equals(other) {
          return this.x == other.x && this.y == other.y;
        }
      }

      let mouse_click_status = 0;

      const rw = 4;

      let start = new Point();
      let end = new Point();

      const directions = [new Point(0, -1), new Point(0, 1), new Point(1, 0), new Point(-1, 0)];

      function bfs(s, e) {
        const found = false;
        const queue = [];

        const visited = [];
        const parent = [];

        queue.push(s);
        visited[s.y][s.x] = 1;

        while (queue.length > 0) {
          const p = queue.pop(0);
          for (const d of directions) {
            const cell = p.add(d);
            if (0 <= cell.x < w && 0 <= cell.y < h && visited[cell.y][cell.x] == 0 && (img[cell.y][cell.x][0] != 0 || img[cell.y][cell.x][1] != 0 || img[cell.y][cell.x][2] != 0)) {
              queue.push(cell);
              visited[cell.y][cell.x] = 1;
              parent[cell.y][cell.x] = p;
              if (cell.equals(e)) {
                found = true;
                queue.length = 0;
                break;
              }
            }
          }
        }

        const path = [];
        if (found) {
          let p = e;

          while (!p.equals(s)) {
            path.push(p);
            p = parent[p.y][p.x];
          }

          path.push(p);
          path.reverse();

          for (const p of path) {
            img[p.y+1][p.x+1] = [0, 0, 255];
            img[p.y][p.x] = [0, 0, 255];
            img[p.y-1][p.x-1] = [0, 0, 255];
            img[p.y+1][p.x-1] = [0, 0, 255];
            img[p.y-1][p.x+1] = [0, 0, 255];
            img[p.y][p.x+1] = [0, 0, 255];
            img[p.y][p.x-1] = [0, 0, 255];
            img[p.y+1][p.x] = [0, 0, 255];
            img[p.y-1][p.x] = [0, 0, 255];
          }
        }
      }

      function mouse_click(event, px, py, flag, params) {
        if (event == cv.EVENT_LBUTTONUP) {
          if (mouse_click_status == 0) {
            cv.rectangle(img, (px-rw, py-rw), (px+rw, py+rw), (0, 255, 255), -1);
            start = new Point(px, py);
            mouse_click_status = mouse_click_status + 1;
          } else if (mouse_click_status == 1) {
            cv.rectangle(img, (px-rw, py-rw), (px+rw, py+rw), (0, 255, 0), -1);
            end = new Point(px, py);
            mouse_click_status = mouse_click_status + 1;
          }
        }
      }

      function display() {
        cv.imshow("image", img);
        cv.setMouseCallback("image", mouse_click);
        while (true) {
          cv.imshow("image", img);
          cv.waitKey(1);
          if (mouse_click_status == 2) {
            break;
          }
        }
      }

      // add event listener to the script tag
      document.currentScript.addEventListener('load', () => {
        // const img = cv.imread("map");
        const h = img.shape[0];
        const w = img.shape[1];
        display();

        bfs(start, end);

        // replace the image with the new image
        cv.imshow("map", img);
      });

      cv['onRuntimeInitialized']=()=>{
        const img = cv.imread("map");
      };

      document.getElementById("map").addEventListener("click", function() {
        mouse_click_status = mouse_click_status + 1;
        // get coordinates of the mouse click
        var x = event.clientX;
        var y = event.clientY;
        // place point on the image
        cv.rectangle(img, (x-rw, y-rw), (x+rw, y+rw), (0, 255, 255), -1);
        // show new image in document.getElementById("map")
        cv.imshow("map", img);
        console.log("Mouse click status: " + mouse_click_status);
        if (mouse_click_status == 2) {
          bfs(start, end);
          cv.imshow("map", img);
          console.log("Path found");
        }
      });
      

    </script> -->
  </body>
</html>